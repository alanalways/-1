/**
 * Discover Latest - Backend Server
 * ç”¨æ–¼ Hugging Face Spaces éƒ¨ç½²
 * 
 * åŠŸèƒ½ï¼š
 * 1. éœæ…‹ç¶²é ä¼ºæœå™¨
 * 2. æ’ç¨‹ä»»å‹™ï¼ˆæ¯æ—¥æ›´æ–°è‚¡ç¥¨æ•¸æ“šï¼‰
 * 3. API Proxyï¼ˆè§£æ±º CORS å•é¡Œï¼‰
 */

import express from 'express';
import cors from 'cors';
import path from 'path';
import { fileURLToPath } from 'url';
import cron from 'node-cron';

// ES Module è·¯å¾‘è™•ç†
const __filename = fileURLToPath(import.meta.url);
const __dirname = path.dirname(__filename);

const app = express();
const PORT = process.env.PORT || 7860;

// === Middleware ===
app.use(cors());
app.use(express.json());

// === éœæ…‹æª”æ¡ˆæœå‹™ ===
app.use(express.static(__dirname));

// === API Proxy ç«¯é» ===
// è§£æ±ºå‰ç«¯ CORS å•é¡Œï¼Œæ‰€æœ‰ API è«‹æ±‚éƒ½é€éå¾Œç«¯ä»£ç™¼

// TWSE Proxy
app.get('/api/twse/:path(.*)', async (req, res) => {
    try {
        const targetPath = req.params.path;
        const queryString = new URLSearchParams(req.query).toString();
        const url = `https://www.twse.com.tw/${targetPath}${queryString ? '?' + queryString : ''}`;

        const response = await fetch(url, {
            headers: { 'User-Agent': 'Mozilla/5.0' }
        });
        const data = await response.text();

        res.set('Content-Type', response.headers.get('content-type') || 'application/json');
        res.send(data);
    } catch (error) {
        console.error('TWSE Proxy Error:', error);
        res.status(500).json({ error: error.message });
    }
});

// TPEx Proxy
app.get('/api/tpex/:path(.*)', async (req, res) => {
    try {
        const targetPath = req.params.path;
        const queryString = new URLSearchParams(req.query).toString();
        const url = `https://www.tpex.org.tw/${targetPath}${queryString ? '?' + queryString : ''}`;

        const response = await fetch(url, {
            headers: { 'User-Agent': 'Mozilla/5.0' }
        });
        const data = await response.text();

        res.set('Content-Type', response.headers.get('content-type') || 'application/json');
        res.send(data);
    } catch (error) {
        console.error('TPEx Proxy Error:', error);
        res.status(500).json({ error: error.message });
    }
});

// Yahoo Finance Proxy
app.get('/api/yahoo/:path(.*)', async (req, res) => {
    try {
        const targetPath = req.params.path;
        const queryString = new URLSearchParams(req.query).toString();
        const url = `https://query1.finance.yahoo.com/${targetPath}${queryString ? '?' + queryString : ''}`;

        const response = await fetch(url, {
            headers: { 'User-Agent': 'Mozilla/5.0' }
        });
        const data = await response.text();

        res.set('Content-Type', response.headers.get('content-type') || 'application/json');
        res.send(data);
    } catch (error) {
        console.error('Yahoo Proxy Error:', error);
        res.status(500).json({ error: error.message });
    }
});



// === å¥åº·æª¢æŸ¥ç«¯é» ===
app.get('/api/health', (req, res) => {
    res.json({
        status: 'ok',
        timestamp: new Date().toISOString(),
        env: process.env.NODE_ENV || 'development'
    });
});

// === æ‰‹å‹•è§¸ç™¼æ›´æ–°ç«¯é» ===
app.post('/api/trigger-update', async (req, res) => {
    console.log('ğŸ“¡ Manual update triggered...');
    try {
        // å‹•æ…‹è¼‰å…¥æ›´æ–°æ¨¡çµ„
        const { runDailyUpdate } = await import('./scripts/daily-update.js');
        await runDailyUpdate();
        res.json({ success: true, message: 'Update completed' });
    } catch (error) {
        console.error('Update failed:', error);
        res.status(500).json({ success: false, error: error.message });
    }
});

// === æ’ç¨‹ä»»å‹™ ===
// å°è‚¡æ”¶ç›¤å¾Œæ›´æ–°ï¼šæ¯å€‹äº¤æ˜“æ—¥ä¸‹åˆ 14:00 (å°åŒ—æ™‚é–“)
// Cron æ ¼å¼ï¼šåˆ† æ™‚ æ—¥ æœˆ é€± (é€±ä¸€åˆ°é€±äº”)
cron.schedule('0 14 * * 1-5', async () => {
    console.log('â° Scheduled update starting...');
    try {
        const { runDailyUpdate } = await import('./scripts/daily-update.js');
        await runDailyUpdate();
        console.log('âœ… Scheduled update completed!');
    } catch (error) {
        console.error('âŒ Scheduled update failed:', error);
    }
}, {
    timezone: 'Asia/Taipei'
});

// === å•Ÿå‹•ä¼ºæœå™¨ ===
app.listen(PORT, '0.0.0.0', () => {
    console.log(`
    ğŸš€ Discover Latest Server Started!
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    ğŸŒ URL: http://localhost:${PORT}
    ğŸ“Š API Proxy: /api/twse, /api/tpex, /api/yahoo
    â° Cron: æ¯å€‹äº¤æ˜“æ—¥ 14:00 æ›´æ–°
    â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
    `);
});
